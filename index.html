<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="USDT Tracker">
    <meta name="description" content="Registro profesional de transacciones USDT">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
    <title>USDT Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%);
            min-height: 100vh;
        }
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .tab-active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .tab-inactive {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.6);
        }
    </style>
</head>
<body class="p-6">
    <div id="installPrompt" class="install-prompt">
        <div class="flex items-center gap-3">
            <span class="text-lg">üì± ¬°Instala la app en tu dispositivo!</span>
            <button onclick="instalarApp()" class="bg-white text-emerald-600 px-4 py-2 rounded-lg font-semibold">
                Instalar
            </button>
            <button onclick="cerrarPrompt()" class="text-white/80 hover:text-white">‚úï</button>
        </div>
    </div>

    <div class="max-w-[1800px] mx-auto">
        <div class="bg-white/10 backdrop-blur-md rounded-2xl shadow-2xl p-8 border border-white/20">
            <!-- Header -->
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3">
                    <svg class="w-10 h-10 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h1 class="text-4xl font-bold text-white">USDT Tracker Pro</h1>
                </div>
                <div class="flex gap-3">
                    <button onclick="toggleCalculadora()" class="bg-purple-500 hover:bg-purple-600 text-white rounded-lg px-4 py-2 font-semibold transition-colors">
                        üßÆ Calculadora
                    </button>
                    <button id="installBtn" onclick="instalarApp()" class="bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg px-4 py-2 font-semibold transition-colors hidden">
                        üì± Instalar
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex gap-2 mb-6 flex-wrap">
                <button onclick="cambiarTab('recogidas')" id="tabRecogidas" class="tab-active px-6 py-3 rounded-lg font-semibold transition-all">
                    üí∞ Recogidas Betcris
                </button>
                <button onclick="cambiarTab('transacciones')" id="tabTransacciones" class="tab-inactive px-6 py-3 rounded-lg font-semibold transition-all">
                    üìä Transacciones USDT
                </button>
                <button onclick="cambiarTab('graficas')" id="tabGraficas" class="tab-inactive px-6 py-3 rounded-lg font-semibold transition-all">
                    üìà Gr√°ficas
                </button>
            </div>

            <!-- Calculadora Flotante -->
            <div id="calculadora" class="hidden fixed top-20 right-6 bg-slate-800 rounded-xl p-6 shadow-2xl border border-emerald-500/30 z-50 w-80">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-white font-bold text-lg">üßÆ Calculadora R√°pida</h3>
                    <button onclick="toggleCalculadora()" class="text-white/60 hover:text-white">‚úï</button>
                </div>
                <input type="number" id="calcInput1" placeholder="N√∫mero 1" class="w-full bg-slate-700 text-white rounded-lg px-4 py-2 mb-2">
                <select id="calcOperacion" class="w-full bg-slate-700 text-white rounded-lg px-4 py-2 mb-2">
                    <option value="+">+</option>
                    <option value="-">-</option>
                    <option value="*">√ó</option>
                    <option value="/">√∑</option>
                </select>
                <input type="number" id="calcInput2" placeholder="N√∫mero 2" class="w-full bg-slate-700 text-white rounded-lg px-4 py-2 mb-3">
                <button onclick="calcular()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg py-2 font-semibold mb-2">
                    Calcular
                </button>
                <div id="calcResultado" class="text-center text-2xl font-bold text-emerald-400"></div>
            </div>

            <!-- SECCI√ìN RECOGIDAS -->
            <div id="seccionRecogidas">
                <!-- Dashboard Liquidaci√≥n -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-yellow-500/20 to-yellow-600/20 rounded-xl p-6 border border-yellow-500/30">
                        <h3 class="text-yellow-300 font-semibold mb-2 text-lg">üíµ Total a Liquidar (USDT)</h3>
                        <p class="text-white text-3xl font-bold" id="totalALiquidar">0.00</p>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-500/20 to-emerald-600/20 rounded-xl p-6 border border-emerald-500/30">
                        <h3 class="text-emerald-300 font-semibold mb-2 text-lg">‚úÖ USDT Comprados</h3>
                        <p class="text-white text-3xl font-bold" id="totalCompradosLiq">0.00</p>
                    </div>
                    <div class="bg-gradient-to-br from-red-500/20 to-red-600/20 rounded-xl p-6 border border-red-500/30">
                        <h3 class="text-red-300 font-semibold mb-2 text-lg">‚è≥ Pendiente Liquidar</h3>
                        <p class="text-white text-3xl font-bold" id="pendienteLiquidar">0.00</p>
                    </div>
                </div>

                <!-- Formulario Recogida -->
                <div class="bg-white/5 rounded-xl p-6 mb-8 border border-white/10">
                    <h2 class="text-xl font-semibold text-white mb-4">üí∞ Nueva Recogida - Betcris</h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <input type="date" id="fechaRecogida" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none">
                        <input type="number" id="montoDOP" placeholder="Monto DOP" step="0.01" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none placeholder-slate-400">
                        <input type="number" id="montoUSD" placeholder="Monto USD" step="0.01" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none placeholder-slate-400">
                        <input type="number" id="tasaDia" placeholder="Tasa DOP‚ÜíUSD" step="0.01" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none placeholder-slate-400">
                        <button onclick="agregarRecogida()" class="bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg px-6 py-2 font-semibold transition-colors">
                            Agregar Recogida
                        </button>
                    </div>
                    <div id="previsualizacion" class="mt-4 bg-slate-800/50 rounded-lg p-4 hidden">
                        <h3 class="text-white font-semibold mb-2">Vista Previa del C√°lculo:</h3>
                        <p class="text-slate-300">DOP convertidos a USD: <span id="prevDOPaUSD" class="text-emerald-400 font-bold">0.00</span> USD</p>
                        <p class="text-slate-300">Total en USD: <span id="prevTotalUSD" class="text-emerald-400 font-bold">0.00</span> USD</p>
                        <p class="text-white text-lg mt-2">USDT a liquidar: <span id="prevUSDT" class="text-yellow-400 font-bold text-xl">0.00</span> USDT</p>
                    </div>
                </div>

                <!-- Tabla Recogidas -->
                <div class="overflow-x-auto mb-8">
                    <table class="w-full text-white text-sm">
                        <thead>
                            <tr class="border-b border-white/20">
                                <th class="text-left py-3 px-3 font-semibold text-emerald-400">Fecha</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">DOP</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">USD</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">Tasa</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">DOP‚ÜíUSD</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">Total USD</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">USDT a Liquidar</th>
                                <th class="text-center py-3 px-3 font-semibold text-emerald-400">Estado</th>
                                <th class="text-center py-3 px-3 font-semibold text-emerald-400">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tablaRecogidas"></tbody>
                    </table>
                </div>
            </div>

            <!-- SECCI√ìN TRANSACCIONES -->
            <div id="seccionTransacciones" class="hidden">
                <!-- Buscador y Filtros -->
                <div class="bg-white/5 rounded-xl p-4 mb-6 border border-white/10">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="buscar" placeholder="üîç Buscar..." onkeyup="filtrarTransacciones()" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none placeholder-slate-400">
                        <input type="date" id="fechaDesde" onchange="filtrarTransacciones()" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none">
                        <input type="date" id="fechaHasta" onchange="filtrarTransacciones()" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none">
                        <select id="filtroTipo" onchange="filtrarTransacciones()" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none">
                            <option value="">Todos los tipos</option>
                            <option value="Compra">Compras</option>
                            <option value="Venta">Ventas</option>
                        </select>
                    </div>
                </div>

                <!-- Formulario Transacci√≥n -->
                <div class="bg-white/5 rounded-xl p-6 mb-8 border border-white/10">
                    <h2 class="text-xl font-semibold text-white mb-4">üìä Nueva Transacci√≥n USDT</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <select id="tipo" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none">
                            <option value="Compra">Compra</option>
                            <option value="Venta">Venta</option>
                        </select>
                        <input type="number" id="cantidadUSDT" placeholder="Cantidad USDT" step="0.01" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none placeholder-slate-400">
                        <select id="divisaPago" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none">
                            <option value="DOP">Pagado en DOP</option>
                            <option value="USD">Pagado en USD</option>
                        </select>
                        <input type="date" id="fecha" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                        <select id="divisaPrecios" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none">
                            <option value="DOP">Precios en DOP</option>
                            <option value="USD">Precios en USD</option>
                        </select>
                        <input type="number" id="precioMercado" placeholder="Precio Mercado" step="0.01" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none placeholder-slate-400">
                        <input type="number" id="tuPrecio" placeholder="Tu Precio" step="0.01" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none placeholder-slate-400">
                        <input type="number" id="tasaCambio" placeholder="Tasa USD‚ÜíDOP" step="0.01" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none placeholder-slate-400">
                        <input type="text" id="notas" placeholder="Notas" class="bg-slate-800 text-white rounded-lg px-4 py-2 border border-slate-600 focus:border-emerald-400 focus:outline-none placeholder-slate-400">
                        <button onclick="agregarTransaccion()" class="bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg px-6 py-2 font-semibold transition-colors">
                            Agregar
                        </button>
                    </div>
                </div>

                <!-- Botones de gesti√≥n -->
                <div class="mb-4 flex gap-4 flex-wrap">
                    <button onclick="exportarDatos()" class="bg-blue-500 hover:bg-blue-600 text-white rounded-lg px-4 py-2 font-semibold transition-colors">
                        üìä Exportar CSV
                    </button>
                    <button onclick="confirmarBorrarTodo()" class="bg-red-500 hover:bg-red-600 text-white rounded-lg px-4 py-2 font-semibold transition-colors">
                        üóëÔ∏è Borrar Todo
                    </button>
                    <button onclick="compartirEstadisticas()" class="bg-purple-500 hover:bg-purple-600 text-white rounded-lg px-4 py-2 font-semibold transition-colors">
                        üì§ Compartir
                    </button>
                </div>

                <!-- Resumen -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-emerald-500/20 to-emerald-600/20 rounded-xl p-6 border border-emerald-500/30">
                        <h3 class="text-emerald-300 font-semibold mb-2 text-lg">Total USDT Comprados</h3>
                        <p class="text-white text-3xl font-bold" id="totalComprados">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500/20 to-orange-600/20 rounded-xl p-6 border border-orange-500/30">
                        <h3 class="text-orange-300 font-semibold mb-2 text-lg">Total USDT Vendidos</h3>
                        <p class="text-white text-3xl font-bold" id="totalVendidos">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500/20 to-blue-600/20 rounded-xl p-6 border border-blue-500/30">
                        <h3 class="text-blue-300 font-semibold mb-2 text-lg">Balance USDT</h3>
                        <p class="text-white text-3xl font-bold" id="balanceUSDT">0</p>
                    </div>
                </div>

                <div id="resumenDetallado" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8"></div>

                <!-- Tabla Transacciones -->
                <div class="overflow-x-auto">
                    <table class="w-full text-white text-sm">
                        <thead>
                            <tr class="border-b border-white/20">
                                <th class="text-left py-3 px-3 font-semibold text-emerald-400">Tipo</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">USDT</th>
                                <th class="text-center py-3 px-3 font-semibold text-emerald-400">Pagado en</th>
                                <th class="text-center py-3 px-3 font-semibold text-emerald-400">Divisa Precios</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">Precio Mercado</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">Tu Precio</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">Monto Total</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">Ganancia/USDT</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">Ganancia Total</th>
                                <th class="text-right py-3 px-3 font-semibold text-emerald-400">Tasa</th>
                                <th class="text-center py-3 px-3 font-semibold text-emerald-400">Fecha</th>
                                <th class="text-left py-3 px-3 font-semibold text-emerald-400">Notas</th>
                                <th class="text-center py-3 px-3 font-semibold text-emerald-400">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tablaTransacciones"></tbody>
                    </table>
                </div>
            </div>

            <!-- SECCI√ìN GR√ÅFICAS -->
            <div id="seccionGraficas" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white/5 rounded-xl p-6 border border-white/10">
                        <h3 class="text-white font-semibold mb-4 text-lg">üìä Ganancias por Mes</h3>
                        <canvas id="graficoGanancias"></canvas>
                    </div>
                    <div class="bg-white/5 rounded-xl p-6 border border-white/10">
                        <h3 class="text-white font-semibold mb-4 text-lg">üí∞ Compras vs Ventas</h3>
                        <canvas id="graficoComprasVentas"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div class="bg-white/5 rounded-xl p-6 border border-white/10">
                        <h3 class="text-white font-semibold mb-4 text-lg">üìà Volumen por Divisa</h3>
                        <canvas id="graficoVolumen"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transacciones = [];
        let recogidas = [];
        let deferredPrompt;
        let transaccionesFiltradas = [];

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('Error SW:', err));
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('installPrompt').style.display = 'block';
            }, 3000);
        });

        function instalarApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                    document.getElementById('installPrompt').style.display = 'none';
                    document.getElementById('installBtn').classList.add('hidden');
                });
            }
        }

        function cerrarPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
        }

        function toggleCalculadora() {
            const calc = document.getElementById('calculadora');
            calc.classList.toggle('hidden');
        }

        function calcular() {
            const num1 = parseFloat(document.getElementById('calcInput1').value) || 0;
            const num2 = parseFloat(document.getElementById('calcInput2').value) || 0;
            const op = document.getElementById('calcOperacion').value;
            let resultado = 0;
            
            switch(op) {
                case '+': resultado = num1 + num2; break;
                case '-': resultado = num1 - num2; break;
                case '*': resultado = num1 * num2; break;
                case '/': resultado = num2 !== 0 ? num1 / num2 : 'Error'; break;
            }
            
            document.getElementById('calcResultado').textContent = typeof resultado === 'number' ? resultado.toFixed(2) : resultado;
        }

        function cambiarTab(tab) {
            document.getElementById('tabRecogidas').className = 'tab-inactive px-6 py-3 rounded-lg font-semibold transition-all';
            document.getElementById('tabTransacciones').className = 'tab-inactive px-6 py-3 rounded-lg font-semibold transition-all';
            document.getElementById('tabGraficas').className = 'tab-inactive px-6 py-3 rounded-lg font-semibold transition-all';
            
            document.getElementById('seccionRecogidas').classList.add('hidden');
            document.getElementById('seccionTransacciones').classList.add('hidden');
            document.getElementById('seccionGraficas').classList.add('hidden');
            
            if (tab === 'recogidas') {
                document.getElementById('tabRecogidas').className = 'tab-active px-6 py-3 rounded-lg font-semibold transition-all';
                document.getElementById('seccionRecogidas').classList.remove('hidden');
            } else if (tab === 'transacciones') {
                document.getElementById('tabTransacciones').className = 'tab-active px-6 py-3 rounded-lg font-semibold transition-all';
                document.getElementById('seccionTransacciones').classList.remove('hidden');
            } else if (tab === 'graficas') {
                document.getElementById('tabGraficas').className = 'tab-active px-6 py-3 rounded-lg font-semibold transition-all';
                document.getElementById('seccionGraficas').classList.remove('hidden');
                actualizarGraficas();
            }
        }

        window.onload = function() {
            cargarDatos();
            document.getElementById('fecha').valueAsDate = new Date();
            document.getElementById('fechaRecogida').valueAsDate = new Date();
            
            // Preview en tiempo real para recogidas
            ['montoDOP', 'montoUSD', 'tasaDia'].forEach(id => {
                document.getElementById(id).addEventListener('input', actualizarPreview);
            });
        };

        function actualizarPreview() {
            const dop = parseFloat(document.getElementById('montoDOP').value) || 0;
            const usd = parseFloat(document.getElementById('montoUSD').value) || 0;
            const tasa = parseFloat(document.getElementById('tasaDia').value) || 0;
            
            if (dop > 0 || usd > 0) {
                const dopAUsd = tasa > 0 ? dop / tasa : 0;
                const totalUsd = dopAUsd + usd;
                const usdtLiquidar = totalUsd / 1.03;
                
                document.getElementById('prevDOPaUSD').textContent = dopAUsd.toFixed(2);
                document.getElementById('prevTotalUSD').textContent = totalUsd.toFixed(2);
                document.getElementById('prevUSDT').textContent = usdtLiquidar.toFixed(2);
                document.getElementById('previsualizacion').classList.remove('hidden');
            } else {
                document.getElementById('previsualizacion').classList.add('hidden');
            }
        }

        function cargarDatos() {
            const datosT = localStorage.getItem('transaccionesUSDT');
            const datosR = localStorage.getItem('recogidasBetcris');
            if (datosT) {
                transacciones = JSON.parse(datosT);
                transaccionesFiltradas = [...transacciones];
                actualizarTablaTransacciones();
            }
            if (datosR) {
                recogidas = JSON.parse(datosR);
                actualizarTablaRecogidas();
            }
        }

        function guardarDatos() {
            localStorage.setItem('transaccionesUSDT', JSON.stringify(transacciones));
            localStorage.setItem('recogidasBetcris', JSON.stringify(recogidas));
        }

        function agregarRecogida() {
            const fecha = document.getElementById('fechaRecogida').value;
            const dop = parseFloat(document.getElementById('montoDOP').value) || 0;
            const usd = parseFloat(document.getElementById('montoUSD').value) || 0;
            const tasa = parseFloat(document.getElementById('tasaDia').value) || 0;

            if (!fecha || (dop === 0 && usd === 0)) {
                alert('Por favor completa la fecha y al menos un monto (DOP o USD)');
                return;
            }

            if (dop > 0 && tasa === 0) {
                alert('Si ingresas DOP, debes especificar la tasa de conversi√≥n');
                return;
            }

            const dopAUsd = tasa > 0 ? dop / tasa : 0;
            const totalUsd = dopAUsd + usd;
            const usdtLiquidar = totalUsd / 1.03;

            const recogida = {
                id: Date.now(),
                fecha,
                dop,
                usd,
                tasa,
                dopAUsd,
                totalUsd,
                usdtLiquidar,
                completada: false
            };

            recogidas.push(recogida);
            guardarDatos();
            actualizarTablaRecogidas();

            document.getElementById('montoDOP').value = '';
            document.getElementById('montoUSD').value = '';
            document.getElementById('tasaDia').value = '';
            document.getElementById('previsualizacion').classList.add('hidden');
        }

        function toggleEstadoRecogida(id) {
            const recogida = recogidas.find(r => r.id === id);
            if (recogida) {
                recogida.completada = !recogida.completada;
                guardarDatos();
                actualizarTablaRecogidas();
            }
        }

        function eliminarRecogida(id) {
            if (confirm('¬øEliminar esta recogida?')) {
                recogidas = recogidas.filter(r => r.id !== id);
                guardarDatos();
                actualizarTablaRecogidas();
            }
        }

        function actualizarTablaRecogidas() {
            const tbody = document.getElementById('tablaRecogidas');
            tbody.innerHTML = '';

            let totalALiquidar = 0;
            let totalComprados = transacciones.filter(t => t.tipo === 'Compra').reduce((sum, t) => sum + t.cantidadUSDT, 0);

            recogidas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(r => {
                totalALiquidar += r.completada ? 0 : r.usdtLiquidar;

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/10 hover:bg-white/5 transition-colors';

                tr.innerHTML = `
                    <td class="py-3 px-3 text-slate-300">${r.fecha}</td>
                    <td class="text-right py-3 px-3 font-mono text-white">${r.dop.toLocaleString('es-DO', {minimumFractionDigits: 2})}</td>
                    <td class="text-right py-3 px-3 font-mono text-white">${r.usd.toLocaleString('es-DO', {minimumFractionDigits: 2})}</td>
                    <td class="text-right py-3 px-3 font-mono text-slate-300">${r.tasa > 0 ? r.tasa.toFixed(2) : '-'}</td>
                    <td class="text-right py-3 px-3 font-mono text-emerald-400">${r.dopAUsd.toFixed(2)}</td>
                    <td class="text-right py-3 px-3 font-mono text-emerald-400 font-semibold">${r.totalUsd.toFixed(2)}</td>
                    <td class="text-right py-3 px-3 font-mono text-yellow-400 font-bold text-base">${r.usdtLiquidar.toFixed(2)}</td>
                    <td class="text-center py-3 px-3">
                        <button onclick="toggleEstadoRecogida(${r.id})" class="px-3 py-1 rounded-full text-xs font-semibold ${r.completada ? 'bg-green-500/20 text-green-300' : 'bg-yellow-500/20 text-yellow-300'}">
                            ${r.completada ? '‚úì Completada' : '‚è≥ Pendiente'}
                        </button>
                    </td>
                    <td class="text-center py-3 px-3">
                        <button onclick="eliminarRecogida(${r.id})" class="text-red-400 hover:text-red-300 transition-colors">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            const pendiente = totalALiquidar - totalComprados;

            document.getElementById('totalALiquidar').textContent = totalALiquidar.toFixed(2);
            document.getElementById('totalCompradosLiq').textContent = totalComprados.toFixed(2);
            document.getElementById('pendienteLiquidar').textContent = pendiente.toFixed(2);
        }

        function agregarTransaccion() {
            const tipo = document.getElementById('tipo').value;
            const cantidadUSDT = parseFloat(document.getElementById('cantidadUSDT').value);
            const divisaPago = document.getElementById('divisaPago').value;
            const divisaPrecios = document.getElementById('divisaPrecios').value;
            const precioMercado = parseFloat(document.getElementById('precioMercado').value);
            const tuPrecio = parseFloat(document.getElementById('tuPrecio').value);
            const tasaCambio = parseFloat(document.getElementById('tasaCambio').value) || null;
            const notas = document.getElementById('notas').value;
            const fecha = document.getElementById('fecha').value;

            if (!cantidadUSDT || !precioMercado || !tuPrecio || !fecha) {
                alert('Completa: Cantidad USDT, Precio Mercado, Tu Precio y Fecha');
                return;
            }

            const gananciaPorUSDT = tipo === 'Compra' ? precioMercado - tuPrecio : tuPrecio - precioMercado;
            const gananciaTotal = gananciaPorUSDT * cantidadUSDT;
            const montoTotal = tuPrecio * cantidadUSDT;

            const transaccion = {
                id: Date.now(),
                tipo,
                cantidadUSDT,
                divisaPago,
                divisaPrecios,
                precioMercado,
                tuPrecio,
                montoTotal,
                gananciaPorUSDT,
                gananciaTotal,
                tasaCambio,
                notas,
                fecha
            };

            transacciones.push(transaccion);
            guardarDatos();
            transaccionesFiltradas = [...transacciones];
            actualizarTablaTransacciones();
            actualizarTablaRecogidas();

            ['cantidadUSDT', 'precioMercado', 'tuPrecio', 'tasaCambio', 'notas'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function eliminarTransaccion(id) {
            if (confirm('¬øEliminar esta transacci√≥n?')) {
                transacciones = transacciones.filter(t => t.id !== id);
                guardarDatos();
                transaccionesFiltradas = [...transacciones];
                actualizarTablaTransacciones();
                actualizarTablaRecogidas();
            }
        }

        function editarTransaccion(id) {
            const t = transacciones.find(x => x.id === id);
            if (!t) return;

            document.getElementById('tipo').value = t.tipo;
            document.getElementById('cantidadUSDT').value = t.cantidadUSDT;
            document.getElementById('divisaPago').value = t.divisaPago;
            document.getElementById('divisaPrecios').value = t.divisaPrecios;
            document.getElementById('precioMercado').value = t.precioMercado;
            document.getElementById('tuPrecio').value = t.tuPrecio;
            document.getElementById('tasaCambio').value = t.tasaCambio || '';
            document.getElementById('notas').value = t.notas || '';
            document.getElementById('fecha').value = t.fecha;

            transacciones = transacciones.filter(x => x.id !== id);
            guardarDatos();
            transaccionesFiltradas = [...transacciones];
            actualizarTablaTransacciones();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function filtrarTransacciones() {
            const buscar = document.getElementById('buscar').value.toLowerCase();
            const desde = document.getElementById('fechaDesde').value;
            const hasta = document.getElementById('fechaHasta').value;
            const tipo = document.getElementById('filtroTipo').value;

            transaccionesFiltradas = transacciones.filter(t => {
                const matchBuscar = !buscar || t.notas?.toLowerCase().includes(buscar);
                const matchDesde = !desde || t.fecha >= desde;
                const matchHasta = !hasta || t.fecha <= hasta;
                const matchTipo = !tipo || t.tipo === tipo;
                return matchBuscar && matchDesde && matchHasta && matchTipo;
            });

            actualizarTablaTransacciones();
        }

        function actualizarTablaTransacciones() {
            const tbody = document.getElementById('tablaTransacciones');
            tbody.innerHTML = '';

            transaccionesFiltradas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(t => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/10 hover:bg-white/5 transition-colors';

                const colorTipo = t.tipo === 'Compra' ? 'bg-blue-500/20 text-blue-300' : 'bg-orange-500/20 text-orange-300';
                const colorGanancia = t.gananciaTotal > 0 ? 'text-green-400' : t.gananciaTotal < 0 ? 'text-red-400' : 'text-slate-400';
                const icono = t.gananciaTotal > 0 ? '‚Üë' : t.gananciaTotal < 0 ? '‚Üì' : '';

                tr.innerHTML = `
                    <td class="py-3 px-3"><span class="${colorTipo} px-3 py-1 rounded-full text-xs font-medium">${t.tipo}</span></td>
                    <td class="text-right py-3 px-3 font-mono font-semibold">${t.cantidadUSDT.toLocaleString('es-DO', {minimumFractionDigits: 2})}</td>
                    <td class="text-center py-3 px-3"><span class="px-2 py-1 bg-slate-700 rounded text-xs font-semibold">${t.divisaPago}</span></td>
                    <td class="text-center py-3 px-3"><span class="px-2 py-1 bg-purple-700 rounded text-xs font-semibold">${t.divisaPrecios}</span></td>
                    <td class="text-right py-3 px-3 font-mono text-slate-300">${t.precioMercado.toFixed(2)} ${t.divisaPrecios}</td>
                    <td class="text-right py-3 px-3 font-mono text-white font-semibold">${t.tuPrecio.toFixed(2)} ${t.divisaPrecios}</td>
                    <td class="text-right py-3 px-3 font-mono text-white">${t.montoTotal.toLocaleString('es-DO', {minimumFractionDigits: 2})} ${t.divisaPrecios}</td>
                    <td class="text-right py-3 px-3 font-mono ${colorGanancia}">${icono}${t.gananciaPorUSDT.toFixed(2)} ${t.divisaPrecios}</td>
                    <td class="text-right py-3 px-3 font-mono ${colorGanancia} font-bold">${icono}${t.gananciaTotal.toLocaleString('es-DO', {minimumFractionDigits: 2})} ${t.divisaPrecios}</td>
                    <td class="text-right py-3 px-3 font-mono text-slate-300">${t.tasaCambio ? t.tasaCambio.toFixed(2) : '-'}</td>
                    <td class="text-center py-3 px-3 text-slate-300">${t.fecha}</td>
                    <td class="py-3 px-3 text-slate-300 text-xs">${t.notas || '-'}</td>
                    <td class="text-center py-3 px-3">
                        <div class="flex gap-2 justify-center">
                            <button onclick="editarTransaccion(${t.id})" class="text-blue-400 hover:text-blue-300">‚úèÔ∏è</button>
                            <button onclick="eliminarTransaccion(${t.id})" class="text-red-400 hover:text-red-300">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            actualizarResumen();
        }

        function actualizarResumen() {
            let totalComprados = 0, totalVendidos = 0;
            const detalles = {
                comprasDOP: { cantidad: 0, monto: 0, ganancia: 0 },
                comprasUSD: { cantidad: 0, monto: 0, ganancia: 0 },
                ventasDOP: { cantidad: 0, monto: 0, ganancia: 0 },
                ventasUSD: { cantidad: 0, monto: 0, ganancia: 0 }
            };

            transacciones.forEach(t => {
                if (t.tipo === 'Compra') {
                    totalComprados += t.cantidadUSDT;
                    const key = t.divisaPrecios === 'DOP' ? 'comprasDOP' : 'comprasUSD';
                    detalles[key].cantidad += t.cantidadUSDT;
                    detalles[key].monto += t.montoTotal;
                    detalles[key].ganancia += t.gananciaTotal;
                } else {
                    totalVendidos += t.cantidadUSDT;
                    const key = t.divisaPrecios === 'DOP' ? 'ventasDOP' : 'ventasUSD';
                    detalles[key].cantidad += t.cantidadUSDT;
                    detalles[key].monto += t.montoTotal;
                    detalles[key].ganancia += t.gananciaTotal;
                }
            });

            document.getElementById('totalComprados').textContent = totalComprados.toLocaleString('es-DO', {minimumFractionDigits: 2});
            document.getElementById('totalVendidos').textContent = totalVendidos.toLocaleString('es-DO', {minimumFractionDigits: 2});
            document.getElementById('balanceUSDT').textContent = (totalComprados - totalVendidos).toLocaleString('es-DO', {minimumFractionDigits: 2});

            const resumen = document.getElementById('resumenDetallado');
            resumen.innerHTML = '';

            const items = [
                { titulo: 'Compras en DOP', data: detalles.comprasDOP, divisa: 'DOP', color: 'from-blue-500/20 to-blue-600/20 border-blue-500/30' },
                { titulo: 'Compras en USD', data: detalles.comprasUSD, divisa: 'USD', color: 'from-cyan-500/20 to-cyan-600/20 border-cyan-500/30' },
                { titulo: 'Ventas en DOP', data: detalles.ventasDOP, divisa: 'DOP', color: 'from-orange-500/20 to-orange-600/20 border-orange-500/30' },
                { titulo: 'Ventas en USD', data: detalles.ventasUSD, divisa: 'USD', color: 'from-amber-500/20 to-amber-600/20 border-amber-500/30' }
            ];

            items.forEach(item => {
                if (item.data.cantidad > 0) {
                    const div = document.createElement('div');
                    div.className = `bg-gradient-to-br ${item.color} rounded-xl p-4 border`;
                    const colorG = item.data.ganancia > 0 ? 'text-green-400' : item.data.ganancia < 0 ? 'text-red-400' : 'text-slate-400';
                    div.innerHTML = `
                        <h3 class="text-white font-semibold mb-3">${item.titulo}</h3>
                        <p class="text-slate-200 text-sm">USDT: <span class="font-mono font-bold">${item.data.cantidad.toLocaleString('es-DO', {minimumFractionDigits: 2})}</span></p>
                        <p class="text-slate-200 text-sm">Monto: <span class="font-mono font-bold">${item.data.monto.toLocaleString('es-DO', {minimumFractionDigits: 2})} ${item.divisa}</span></p>
                        <p class="text-sm">Ganancia: <span class="font-mono font-bold ${colorG}">${item.data.ganancia.toLocaleString('es-DO', {minimumFractionDigits: 2})} ${item.divisa}</span></p>
                    `;
                    resumen.appendChild(div);
                }
            });
        }

        function actualizarGraficas() {
            // Gr√°fico Ganancias por Mes
            const meses = {};
            transacciones.forEach(t => {
                const mes = t.fecha.substring(0, 7);
                meses[mes] = (meses[mes] || 0) + t.gananciaTotal;
            });

            const ctxGanancias = document.getElementById('graficoGanancias');
            if (window.chartGanancias) window.chartGanancias.destroy();
            window.chartGanancias = new Chart(ctxGanancias, {
                type: 'line',
                data: {
                    labels: Object.keys(meses).sort(),
                    datasets: [{
                        label: 'Ganancias',
                        data: Object.keys(meses).sort().map(m => meses[m]),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Gr√°fico Compras vs Ventas
            const compras = transacciones.filter(t => t.tipo === 'Compra').reduce((s, t) => s + t.cantidadUSDT, 0);
            const ventas = transacciones.filter(t => t.tipo === 'Venta').reduce((s, t) => s + t.cantidadUSDT, 0);

            const ctxCV = document.getElementById('graficoComprasVentas');
            if (window.chartCV) window.chartCV.destroy();
            window.chartCV = new Chart(ctxCV, {
                type: 'doughnut',
                data: {
                    labels: ['Compras', 'Ventas'],
                    datasets: [{
                        data: [compras, ventas],
                        backgroundColor: ['#3b82f6', '#f97316']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });

            // Gr√°fico Volumen por Divisa
            const volDOP = transacciones.filter(t => t.divisaPrecios === 'DOP').reduce((s, t) => s + t.montoTotal, 0);
            const volUSD = transacciones.filter(t => t.divisaPrecios === 'USD').reduce((s, t) => s + t.montoTotal, 0);

            const ctxVol = document.getElementById('graficoVolumen');
            if (window.chartVol) window.chartVol.destroy();
            window.chartVol = new Chart(ctxVol, {
                type: 'bar',
                data: {
                    labels: ['DOP', 'USD'],
                    datasets: [{
                        label: 'Volumen Total',
                        data: [volDOP, volUSD],
                        backgroundColor: ['#8b5cf6', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        function exportarDatos() {
            if (transacciones.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            let csv = 'Tipo,Cantidad USDT,Pagado en,Divisa Precios,Precio Mercado,Tu Precio,Monto Total,Ganancia por USDT,Ganancia Total,Tasa,Fecha,Notas\n';
            transacciones.forEach(t => {
                csv += `${t.tipo},${t.cantidadUSDT},${t.divisaPago},${t.divisaPrecios},${t.precioMercado},${t.tuPrecio},${t.montoTotal},${t.gananciaPorUSDT},${t.gananciaTotal},${t.tasaCambio || ''},${t.fecha},"${t.notas || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transacciones_usdt_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        async function compartirEstadisticas() {
            const comprados = transacciones.filter(t => t.tipo === 'Compra').reduce((s, t) => s + t.cantidadUSDT, 0);
            const vendidos = transacciones.filter(t => t.tipo === 'Venta').reduce((s, t) => s + t.cantidadUSDT, 0);
            const ganancias = transacciones.reduce((s, t) => s + t.gananciaTotal, 0);
            
            const texto = `üìä USDT Tracker:\n\nüí∞ Comprados: ${comprados.toFixed(2)}\nüí∏ Vendidos: ${vendidos.toFixed(2)}\nüìà Balance: ${(comprados - vendidos).toFixed(2)}\n‚ú® Ganancias: ${ganancias.toFixed(2)}`;

            if (navigator.share) {
                try {
                    await navigator.share({ title: 'USDT Tracker', text: texto });
                } catch (err) {}
            } else {
                alert(texto);
            }
        }

        function confirmarBorrarTodo() {
            if (confirm('¬øBORRAR TODAS las transacciones? No se puede deshacer.')) {
                if (confirm('√öltima confirmaci√≥n:')) {
                    transacciones = [];
                    guardarDatos();
                    transaccionesFiltradas = [];
                    actualizarTablaTransacciones();
                    alert('Transacciones eliminadas');
                }
            }
        }
    </script>
</body>
</html>
